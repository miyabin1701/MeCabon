# MeCabon

何処にでもあるライトノベル（テキストファイル）リーダー

# DEMO

![MeCabon実行中画面](https://github.com/miyabin1701/MeCabon/blob/images/Mecabon-corpas4.png)

# Features

長文(17Mでテストしました）でも読み上げられるようにしました。
形態素解析ライブラリMeCabを使っていますので、辞書を育てていけば誤読を減らしていけると考えています。利用者の皆様の何々ノベル用辞書（コーパス）を各々公開して頂ければ、より誤読の少ない辞書を作っていけると信じています。お願いします。

# Requirement

MeCabon 動作に必要なライブラリ

* libmecab.dll(x64) 同梱 形態素解析ライブラリ
* MeCab その他のexeファイル 辞書の更新に使用します。Binary package for MS-Windows
      [https://taku910.github.io/mecab/]
* AquesTalk.dll 株式会社 アクエストさんの音声合成エンジン
    [https://www.a-quest.com/]

# Installation

* 上記 MeCab のURLより、Binary package for MS-Windowsをダウンロードしインストールしてください。このパッケージ内のdllやexeファイルは32Bitビルドです。 Mecabon.exe と同じフォルダーに libmecab.dll 64Bitビルド版を同梱しています。
  
* Vectorさんで配布させていただいている実行環境のアーカイブには AquesTalk.dll を同梱しています。Githubでソースをダウンロードされた場合は上記の株式会社 アクエストさんのホームページのダウンロードリンクから AquesTalk10 Win をダウンロードして、 AquesTalk.dll を Mecabon.exe と同じフォルダーにコピーしてください。
  
# Usage

MeCabonを起動するとメインダイヤログが表示されます。
最初にご利用の際は、設定ダイヤログの Mecab タブの項目について設定を行ってください。
設定ダイヤログの表示はエディットコントロール内で右クリックした際のポップアップ
メニューから行ってください。

![設定ダイヤログ](https://github.com/miyabin1701/MeCabon/blob/images/Mecabon-corpas8a.png)

1. Mecab.exeのパス
辞書更新時はこのパスからmecab-dict-index.exe等他のツールを起動します。

2. システム辞書フォルダー
下記辞書ホルダー構成の n:\\.......\final の部分を設定してください。

3. システム辞書構築フォルダー
辞書構築フォルダーは下記構成となります。
n:\\.......\work の部分を設定してください。
    n:\\......\work\seed
                    \final

4. 文字セットは現在UTF-8固定になっています。
text editorは、utf-8文字セットが使える物なら、普段使いのエディターを設定してください。
utf-8が使えない場合はnotepad++が良いかもしれません。
5. editor optionは、エディター起動オプションでタグジャンプ時の行番号とファイルパスの
与え方を指定してください。csv辞書ファイル検索後、該当位置にタグジャンプするための設定です。

    notepad++の場合は -n%l %f です。%l は行番号に、%f はファイル名に置き換えられます。

6. 一番下に TTS セレクト用リストボックスがありますので、とりあえず、AQTK10でお試しください。
このセレクタの設定されているTTSのオプションタブを開くことができます。
TTS設定タブは、とりあえず、いじらなくても発声することが可能です。

OKボタンで設定ダイヤログを閉じてください。

後は、メインダイヤログのエディットコントロールにテキストをコピペするか、テキストファイルをドラッグドロップするかして、PLAYボタンを押すだけです。PLAY状態になるとPLAYボタンはPOUSEボタンに替わります。
発声時、Mecabの未登録語（以後未知語）やAquesTalkのWAVE生成エラーは別ダイヤログに表示
されます。発声の停止はSTOPボタンでお願いします。

ファイルのドラッグドロップ時は、一応文字コード判別（UTF-8,UTF16-LE等）を行い変換を行って
いますが、何でも変換できるわけではございませんので、予めユニコードに変換されることをお勧めします。

初見の文章は Mecab の未知語が多数出てくると思われます。この際、発声はスキップして未知語を
すべて洗い出して、未知語を辞書に登録する方がいいと思います。発声スキップオプションもポップアップメニューにつけています。ご利用ください。例えばカタカナの名前で在っても、登録することで前後の漢字の解析精度が上がるようです。

発声時に、読み間違いも出てきます。聞いていて違うと感じた際は、PAUSE して読み間違いの文章を選択して、ポップアップメニューの corpas を使ってください。別ダイヤログにコーパス形式の表示を行います。読み間違いの語彙のコーパス行にカーソルを持っていき、ポップアップメニューの検索を行ってください。別ダイヤログの検索文字列エリアに半角カンマをアペンドして張り付けますので。改めて、検索ボタンを押してください。csv辞書ファイル検索結果を表示します。正解の読み品詞があればテキストエディタにコーパスダイヤログの一連のコーパス行をコピペして頂き、読み間違い行を検索結果の読み正解行に置き換えてください。もし、csv辞書検索結果に読みの正解が表示されなかった場合は、追加用の辞書に登録していってください。また、送り仮名の過不足で検索ができないことも在ります。検索文字列に追記して検索することで検索できることもありました。

コーパスとcsv検索他ダイヤログ
![1. ](https://github.com/miyabin1701/MeCabon/blob/images/Mecabon-corpas2.png)
![2. ](https://github.com/miyabin1701/MeCabon/blob/images/Mecabon-corpas3.png)
![3. ](https://github.com/miyabin1701/MeCabon/blob/images/Mecabon-corpas5.png)
![4. ](https://github.com/miyabin1701/MeCabon/blob/images/Mecabon-corpas6.png)

ある程度、新規追加語、コーパスがたまったら、辞書を更新してください。csv辞書検索他ダイヤ
ログの buildsysdic ボタンで更新できます。少し時間がかかります。辞書更新の際は、STOPボタンで発声を停止してください。発声中は libmecab.dll が辞書を開いているためロックがかかってファイルの更新ができないのです。そのうえ、見た目は正常に更新終了したと振舞うため更新したのに出来ていなかったことがあり得ます。

辞書のビルドエラーについて、追加した語彙又は、コーパスファイルのフォーマットエラー、ファイル末尾の改行だけの行であることがほとんどです。追加した部分を再確認してください。追加用の辞書は、一般的な語彙の辞書とその本専用辞書（登場人物の名前や特有の言い回し）を分けて行うと良いでしょう。work\seed フォルダー内であれば拡張子が.csvのファイルを追加してもmecabは辞書をビルドしてくれます。

メインダイヤログのポップアップメニューでその他に

![メインダイヤログのポップアップメニュー](https://github.com/miyabin1701/MeCabon/blob/images/Mecabon-corpas7.png)

1. ディスプレイ電源連動 PAUSE PCで設定時間後にモニターの電源を切る設定を行っていた際に自動で PAUSE します。モニターのスピーカーから音を出している場合にお使いください。私の寝落ち対策；；また、モニター電源オフ時にも再生可能なUSBスピーカーなどから鳴らす場合はチェックを外してください。メッセージが来ないときがあるようで PAUSE にならない時が在るようです。気休め程度とお考え下さい。
2. 記号読みパス 通常！マークなどいくつかの記号（発音記号でない記号）を"びっくり"等と発声します。
それをパスする際の設定です。辞書で登録している記号の読みは除きます。
3. 発声スキップ 先ほど述べた、初見の文章の未知語を洗い出すためのオプションです。
4. この行から再生カーソルのある行から再生します。
5. この上の行まで削除 先頭からカーソルのある行の上の行まで削除します。
6. 前回ドラッグ＆ドロップしたファイルパス 続きを読めるようにしました。前回 MeCabon を終了した時に持っていた行番号付近にスクロールしますので、上記この行から再生メニューで再生してください。

メインダイヤログの下部のボタンなど

1. 検索ボタン 横のエディットボックス内の文字列を検索します。前回何話まで読んだ等の場合、（何＋１）話等の文字列を検索してください。
何メガもの文章を読み込めるので、検索機能が無いと探すのが辛かったので追加しました。
2. Volumeスライドバー サウンドAPIのボリューム設定です。即時音量を変えられます。
設定ダイヤログの各TTSの設定内にもボリューム設定がありますが、そちらは、生成波形の大きさを
コントロールします。当然、波形生成済みで再生キューに入っている分は音量を変化することはできません。
3. ダイヤログ内の文字サイズ CTRL＋ジョグダイヤルで変更可能です。

メインダイヤログのエディットコントロールは読んでいる際、読んでいる行辺りを反転表示します。しかし、何行かをキューに入れるので、その辺り程度とご理解ください。

メインダイヤログのエディットコントロールにどの程度の容量のテキストファイルを読み込めるのか？ですが、今のところ17M程度は大丈夫のようでした。何らか(PCのメモリー容量等)の制限があるかもしれませんが．．．

小説家になろうサイトの下記二つのタイトルで動作確認を行いました。

1. 17Mの本好きの下克上（PDFをテキスト化した後１行が長すぎないよう改行を追加した、１ページの文章が１行としてPDF内に入っています。１行がUTF8で１０００文字未満になるよう適度に改行を
入れてください。）
2. 6.5Mの転生したらスライムだった件（テキストファイルをDL後全話を１ファイルにまとめたもの）

# Note

* ビルド時 aqtk10regst.h が無いとエラーが出ると思います。これは、 AquesTalk.dll のレジストコードのみを収めたヘッダーです。必要な方は株式会社 アクエストさんにレジストコードを発行していただいて新規にヘッダーファイルを作成し、発行されたレジストコードを記載してください。
* このソフトの改良を一緒に行って頂ける方募集中です。

# Author

* miyabin

# License

"MeCabon" は MeCab に習い[LGPL]といたします。



・謝辞

　このプログラムを作るにあたり、色々なツールやWebサイトを参考にさせていただきました。
ありがとうございます。


MeCabは 京都大学情報学研究科−日本電信電話株式会社コミュニケーション科学基礎研究所 共同研究
ユニットプロジェクトを通じて開発されたオープンソース 形態素解析エンジンです。

https://taku910.github.io/mecab/

MeCab用IPA辞書
https://taku910.github.io/mecab/#install-windows	本ソフトではUTF-8の辞書を使用しているた
め、UTF-8変換したcsvファイルを同梱しています。

MeCab用IPA辞書のモデルファイル
https://taku910.github.io/mecab/dic.html　ここのコストの自動推定機能の章にダウンロードリンク
が在ります。辞書構築に必要ですので同梱しています。

MeCab用sys.dicビルド方法
https://taku910.github.io/mecab/learn.html


　本ソフトは、(株)アクエストの音声合成ライブラリAquesTalkを使用しており、その著作権は同社に
帰属します。営利目的での使用は当該ライブラリの使用ライセンスが必要です。

https://www.a-quest.com/index.html


　2022/04　追記
・VOICEVOXの音声をSAPIで選択できるようにしました。
　　VOICEVOXとSAPIForVOICEVOXを使わせていただきました。有難うございます。
　　MicrosoftのHarukaさん達の様に、変換音声の前後に長い無音区間が入らないようで聞き取りやすいです。

　ヒホさんのVOICEVOX
	https://voicevox.hiroshiba.jp/
	https://github.com/VOICEVOX

　shigobuさんのSAPIForVOICEVOX
	https://github.com/shigobu/SAPIForVOICEVOX

　VOICEVOXは内部でpyopenjtalkを、pyopenjtalkは内部でMeCab辞書を読み出しています。
　JTALK用のMeCab辞書は、通常のMeCab辞書に２つの追加データが入っているため、今後、JTALK下のMeCab辞書を
　更新するようにしなければなりません。現状では、通常辞書のMeCabでかな変換後VOICEVOXに渡しているため、
　JTALKのアクセント、イントネーションが生かされません。

 2022/05 追記
・VOICEVOXのrun.exeの自動起動を追加しました。また、辞書ビルドの際はrun.exeを自動終了します。
　run.exeは起動後十数秒間データを受け付けられない時間が存在します。SAPIForVOICEVOX側で受け付けら
　れない時にエクセプションにならない対策を講じていただきましたが、その間に送ったデータは読み上げ
　られずに抜けてしまいます。この対策として、run.exeの標準出力をパイプでキャプチャーして準備完了
　メッセージが出力されるのを待つようにしました。標準出力のパイプリダイレクトのため、その後も
　run.exeの起動中はずっと読み捨てしているためだけのスレッドが稼働しています。
　他に軽いrun.exeの準備完了判断方法御座いましたら教えてください。

・小説家になろうサイトの縦書きPDF（ヒナプロジェクト）のテキスト入りPDFファイルの自動テキストファ
　イル変換機能を追加しました。ページ番号とルビの自動抜き機能を含んでいます。まだ、評価機能程度と
　認識してお使いください。テキストファイルと同様にpdfファイルをドロップするだけで、テキストファ
　イル化して、そのテキストファイルを読みこみます。（テキスト化しておかないと、長い小説の続きを聞
　きたいときにポップアップメニューの続き読み機能が効かないかと思いました。）
　Rich Geldreich <richgel99@gmail.com>さんのminiz.c v1.15を圧縮ストリームの展開に使わせていた
　だきました。

・現在、これまでMecab用に構築してきた辞書をVOICEVOXで使えるよう、辞書のビルドを可能にしたいと考
　えています。ただ、辞書のJtalk用の追加の２つのデータでjtalk用の辞書に無い語彙は機械的には調整
　できませんので、定型で追加します。",0/n,*"（nは読みの文字数）各語彙のアクセント調整をしてい
　ただける方募集中です。


